# escape=`
FROM mcr.microsoft.com/windows/servercore:ltsc2022

SHELL ["powershell.exe"]

RUN $global:ErrorActionPreference = 'Stop'; `
    mkdir 'c:\Program Files\LogMonitor'; `
    Invoke-WebRequest -Uri "https://github.com/microsoft/windows-container-tools/releases/download/v2.0.2/LogMonitor.exe" -OutFile 'c:\Program Files\LogMonitor\LogMonitor.exe'

# Change the default to something a little bit larger than the default 5s.... 15s
# https://github.com/dotnet/runtime/issues/63709
RUN $global:ErrorActionPreference = 'Stop'; `
    reg add hklm\system\currentcontrolset\services\cexecsvc /v ProcessShutdownTimeoutSeconds /t REG_DWORD /d 15; `
    reg add hklm\system\currentcontrolset\control /v WaitToKillServiceTimeout /t REG_SZ /d 15000 /f;

COPY "setup\\external" "C:\\setup"
RUN xcopy /E /Y "c:\\setup\\assets" "C:\\"
RUN echo "setup\\external";c:\setup\setup.ps1
RUN Remove-Item -Path c:\setup -Recurse -Force;

COPY "setup\\logrotate" "C:\\setup"
RUN xcopy /E /Y "c:\\setup\\assets" "C:\\"
RUN echo "setup\\logrotate";c:\setup\setup.ps1
RUN Remove-Item -Path c:\setup -Recurse -Force;

COPY "setup\\base" "C:\\setup"
RUN xcopy /E /Y "c:\\setup\\assets" "C:\\"
RUN echo "setup\\base";c:\setup\setup.ps1
RUN Remove-Item -Path c:\setup -Recurse -Force;

# SHELL ["cmd.exe"]
# CMD ["powershell.exe", "-File", "C:\\entrypoint\\entrypoint.ps1" ]

CMD ["c:\\Program Files\\LogMonitor\\LogMonitor.exe", "/CONFIG", "c:\\logmonitor\\config.json", "powershell.exe", "-File", "C:\\entrypoint\\entrypoint.ps1" ]