trigger:
  branches:
    include:
    - '*'
resources:
- repo: self
variables:
  tag: '$(Build.BuildId)'
  vmImageName: 'windows-2022'
stages:
- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build
    timeoutInMinutes: 120
    displayName: Build
    pool:
      vmImage: $(vmImageName)
      name: Default
    steps:
    - script: pwsh -Command ".\buildall.ps1"
      env:
        REGISTRY_USER: $(REGISTRY_USER)
        REGISTRY_PWD: $(REGISTRY_PWD)
        MSSQLINSTALL_CU_URL: $(MSSQLINSTALL_CU_URL)
        MSSQLINSTALL_CUFIX_URL: $(MSSQLINSTALL_CUFIX_URL)
        MSSQLINSTALL_ISO_URL: $(MSSQLINSTALL_ISO_URL)
        REGISTRY_PATH: $(REGISTRY_PATH)
        IMAGE_VERSION: $(Build.SourceBranchName)

    - script: pwsh -Command ".\buildall.ps1 -Test"
      # Only build if [build] is present
      condition: not(contains(variables['Build.SourceVersionMessage'], '[notest]'))
      env:
        REGISTRY_USER: $(REGISTRY_USER)
        REGISTRY_PWD: $(REGISTRY_PWD)
        MSSQLINSTALL_CU_URL: $(MSSQLINSTALL_CU_URL)
        MSSQLINSTALL_CUFIX_URL: $(MSSQLINSTALL_CUFIX_URL)
        MSSQLINSTALL_ISO_URL: $(MSSQLINSTALL_ISO_URL)
        REGISTRY_PATH: $(REGISTRY_PATH)
        IMAGE_VERSION: $(Build.SourceBranchName)
        
    - script: pwsh -Command ".\buildall.ps1 -Push"
      # Only push if this is a tag, and the tests passed
      condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'))
      env:
        REGISTRY_USER: $(REGISTRY_USER)
        REGISTRY_PWD: $(REGISTRY_PWD)
        MSSQLINSTALL_CU_URL: $(MSSQLINSTALL_CU_URL)
        MSSQLINSTALL_CUFIX_URL: $(MSSQLINSTALL_CUFIX_URL)
        MSSQLINSTALL_ISO_URL: $(MSSQLINSTALL_ISO_URL)
        REGISTRY_PATH: $(REGISTRY_PATH)
        IMAGE_VERSION: $(Build.SourceBranchName)
