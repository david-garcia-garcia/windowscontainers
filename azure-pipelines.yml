trigger:
  branches:
    include:
      - "*"
  tags:
    include:
      - "*"
pr:
  branches:
    exclude:
      - "*"
resources:
  - repo: self
variables:
  tag: "$(Build.BuildId)"
  vmImageName: "windows-2022"
  # Common environment variables
  REGISTRY_USER: $(REGISTRY_USER)
  REGISTRY_PWD: $(REGISTRY_PWD)
  MSSQLINSTALL_CU_URL: $(MSSQLINSTALL_CU_URL)
  MSSQLINSTALL_CUFIX_URL: $(MSSQLINSTALL_CUFIX_URL)
  MSSQLINSTALL_ISO_URL: $(MSSQLINSTALL_ISO_URL)
  MSSQL2019LINSTALL_CU_URL: $(MSSQL2019INSTALL_CU_URL)
  MSSQL2019INSTALL_CUFIX_URL: $(MSSQL2019INSTALL_CUFIX_URL)
  MSSQL2019INSTALL_ISO_URL: $(MSSQL2019INSTALL_ISO_URL)
  MSSQL2017LINSTALL_CU_URL: $(MSSQL2017INSTALL_CU_URL)
  MSSQL2017INSTALL_CUFIX_URL: $(MSSQL2017INSTALL_CUFIX_URL)
  MSSQL2017INSTALL_ISO_URL: $(MSSQL2017INSTALL_ISO_URL)
  REGISTRY_PATH: $(REGISTRY_PATH)
  IMAGE_VERSION: $(Build.SourceBranchName)
  TEMP: $(Agent.TempDirectory)
  TESTS_SAS_URL: $(TESTS_SAS_URL)
stages:
  - stage: Build
    displayName: Build and push stage
    jobs:
      - job: Build_servercore2022
        timeoutInMinutes: 30
        displayName: Build_servercore2022
        pool: { vmImage: $(vmImageName), name: Test-Rafael }
        steps:
          - pwsh: .\buildall.ps1 -Images "^servercore2022$"
            name: build_images
          - pwsh: .\buildall.ps1 -Test -Images "^servercore2022$"
            name: run_tests
            condition: not(contains(variables['Build.SourceVersionMessage'], '[notest]'))
          - task: PublishTestResults@2
            name: publish_tests_results
            condition: and(not(canceled()), not(contains(variables['Build.SourceVersionMessage'], '[notest]')))
            inputs:
              testResultsFormat: "NUnit"
              testResultsFiles: "**/*.xml"
              searchFolder: "$(System.DefaultWorkingDirectory)/NUnit"
              failTaskOnFailedTests: true
              failTaskOnFailureToPublishResults: true
              failTaskOnMissingResultsFile: true
              testRunTitle: Pester
              publishRunAttachments: true
          - pwsh: .\buildall.ps1 -Push -Images "^servercore2022$"
            name: push_containers
            condition: or(and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/')), contains(variables['Build.SourceVersionMessage'], '[push]'))